name: Auditor√≠a SQL (NOLOCK)

on:
  push:
    paths:
      - 'auditSQL/**/*.sql'
      - 'audit_nolock.py'
      - '.github/workflows/sqlfluff-lint.yml'
  pull_request:
    paths:
      - 'auditSQL/**/*.sql'
      - 'audit_nolock.py'
      - '.github/workflows/sqlfluff-lint.yml'

jobs:
  audit-nolock:
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Clonar el repositorio
        uses: actions/checkout@v3

      - name: üêç Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: üß∞ Instalar dependencias
        run: |
          pip install -r requirements.txt || echo "sin requirements.txt"

      - name: üîç Ejecutar auditor√≠a NOLOCK en todos los .sql
        run: |
          echo "Buscando archivos .sql en auditSQL/..."
          shopt -s globstar
          errored=0
          for file in auditSQL/**/*.sql; do
            if [[ -f "$file" ]]; then
              echo "üìÑ Analizando: $file"
              python audit_nolock.py "$file" || errored=1
            fi
          done
          if [[ $errored -eq 1 ]]; then
            echo "‚ùå Se encontraron errores en uno o m√°s archivos SQL"
            exit 1
          else
            echo "‚úÖ Auditor√≠a completada correctamente para todos los archivos SQL"
          fi
